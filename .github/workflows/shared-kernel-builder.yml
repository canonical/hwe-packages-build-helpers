---
name: Kernel Build

on:
  workflow_call:
    inputs:
      repository:
        description: >
          Source repository to checkout. Passed to actions/checkout.
        type: string
        required: true
      ref:
        description: >
          Source repository reference to checkout. Passed to actions/checkout.
        type: string
        required: true
      artifacts-name:
        description: >
          Name of the artifact to upload. Passed to actions/upload-artifact.
        type: string
        default: 'artifacts'
      retention-days:
        description: >
          Duration after which artifact will expire in days. Passed to
          actions/upload-artifact.
        type: number
        default: 0
    outputs:
      out:
        description: 'Actual artifacts output path used.'
        value: ${{ jobs.build.outputs.out }}
      artifact-id:
        description: 'GitHub ID of an Artifact, can be used by the REST API.'
        value: ${{ jobs.build.outputs.artifact_id }}
      artifact-url:
        description: 'URL to download an Artifact.'
        value: ${{ jobs.build.outputs.artifact_url }}
      artifact-digest:
        description: 'SHA-256 digest of an Artifact.'
        value: ${{ jobs.build.outputs.artifact_digest }}

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  build:
    name: Build kernel from ${{ inputs.repository }}@${{ inputs.ref }}
    runs-on: ubuntu-latest
    outputs:
      out: ${{ steps.build.outputs.out }}
      artifact_id: ${{ steps.artifacts.outputs.artifact-id }}
      artifact_url: ${{ steps.artifacts.outputs.artifact-url }}
      artifact_digest: ${{ steps.artifacts.outputs.artifact-digest }}
    steps:
      - name: Checkout workflows
        uses: actions/checkout@v6
        with:
          repository: ${{ inputs.repository }}
          ref: ${{ inputs.ref }}
          fetch-depth: 1

      # Without correct rustc version installed, Ubuntu kernel build fails due
      # to config changes.
      - name: Remove pre-installed rustc
        shell: sh
        run: rm -rf ~/.cargo

      # Need more free spaces than currently available to build kernel
      - name: Prune software
        uses: canonical/hwe-packages-build-helpers/actions/prune-software@v1

      - name: Bump package version
        shell: bash
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          RUN_NUMBER: ${{ github.run_number }}
        run: |
          set -e

          # Read DEBIAN directory from debian/debian.env
          if [ ! -f "debian/debian.env" ]; then
            echo "Error: debian/debian.env not found"
            exit 1
          fi

          DEBIAN_DIR=$(grep '^DEBIAN=' debian/debian.env | cut -d'=' -f2)
          if [ -z "$DEBIAN_DIR" ]; then
            echo "Error: Could not read DEBIAN directory from debian/debian.env"
            exit 1
          fi

          CHANGELOG_FILE="${DEBIAN_DIR}/changelog"

          if [ ! -f "$CHANGELOG_FILE" ]; then
            echo "Error: $CHANGELOG_FILE not found"
            exit 1
          fi

          echo "Using changelog file: $CHANGELOG_FILE"

          # Read the current version from changelog
          CURRENT_VERSION=$(dpkg-parsechangelog -l "$CHANGELOG_FILE" -S Version)
          echo "Current version: $CURRENT_VERSION"

          # Extract base version and build numbers
          # Format: 6.8.0-5.5, 6.8.0-88.89, or 6.14.0-1011.11
          if [[ $CURRENT_VERSION =~ ^([0-9]+\.[0-9]+\.[0-9]+)-([0-9]+)\.([0-9]+)(.*)$ ]]; then
            BASE_VERSION="${BASH_REMATCH[1]}"
            BUILD_NUM="${BASH_REMATCH[2]}"
            SUB_VERSION="${BASH_REMATCH[3]}"
            VERSION_SUFFIX="${BASH_REMATCH[4]}"

            # Determine new build number based on length
            BUILD_NUM_LEN=${#BUILD_NUM}
            if [ "$BUILD_NUM_LEN" -eq 1 ]; then
              # 1-digit: prepend "100" (5 -> 1005)
              NEW_BUILD_NUM="100${BUILD_NUM}"
            elif [ "$BUILD_NUM_LEN" -eq 2 ]; then
              # 2-digit: prepend "10" (88 -> 1088)
              NEW_BUILD_NUM="10${BUILD_NUM}"
            elif [ "$BUILD_NUM_LEN" -eq 3 ]; then
              # 3-digit: prepend "1" (011 -> 1011)
              NEW_BUILD_NUM="1${BUILD_NUM}"
            elif [ "$BUILD_NUM_LEN" -eq 4 ] && [[ $BUILD_NUM =~ ^1 ]]; then
              # 4-digit starting with "1": replace first digit with "7" (1011 -> 7011)
              SUFFIX=${BUILD_NUM:1}
              NEW_BUILD_NUM="7${SUFFIX}"
            else
              echo "Error: Unexpected build number format: $BUILD_NUM"
              exit 1
            fi

            # Construct version suffix with PR and run number
            SUFFIX_STR="pr${PR_NUMBER}.run${RUN_NUMBER}"
            NEW_VERSION="${BASE_VERSION}-${NEW_BUILD_NUM}.${SUB_VERSION}+${SUFFIX_STR}"

            echo "New version: $NEW_VERSION"

            # Use dch to bump the version
            DEBFULLNAME="GitHub Actions" DEBEMAIL="noreply@github.com" \
              dch --changelog "$CHANGELOG_FILE" \
                  --newversion "$NEW_VERSION" \
                  --distribution UNRELEASED \
                  "Automated version bump for CI build"

            echo "Version bumped successfully to ${NEW_VERSION}"
          else
            echo "Error: Could not parse version from changelog: $CURRENT_VERSION"
            exit 1
          fi

      - name: Build
        id: build
        uses: canonical/hwe-packages-build-helpers/actions/kernel-builder@v1

      - name: Upload artifacts
        if: ${{ !cancelled() }}
        id: artifacts
        uses: actions/upload-artifact@v6
        with:
          name: ${{ inputs.artifacts-name }}
          path: |
            ${{ steps.build.outputs.out }}/build.log
            ${{ steps.build.outputs.out }}/*.buildinfo
            ${{ steps.build.outputs.out }}/*.changes
            ${{ steps.build.outputs.out }}/*.deb
            ${{ steps.build.outputs.out }}/*.dsc
            ${{ steps.build.outputs.out }}/*.tar.*
          retention-days: ${{ inputs.retention-days }}

      - env:
          RESULT: ${{ steps.build.outcome }}
        shell: sh
        run: test "${RESULT}" = "success"
